version: 1.0.{build}
image: Visual Studio 2022
build: off

clone_folder: C:\source

configuration:
  - BuildIntegTesting
  - BuildIntegTestingJavaPythonProvided
  - BuildIntegTestingArm64
  - AllTerraformBuildTesting
  - PackageAndDeleteAndDeployIntegTesting
  - SyncIntegTesting
  - LocalInvokeIntegTesting
  - LocalStartApiIntegTesting
  - LocalStartLambdaIntegTesting
  # other Integration testing, Dev, regression and smoke testing
  - OtherAndEndToEndTesting

environment:
  AWS_DEFAULT_REGION: us-east-1
  CARGO_LAMBDA_VERSION: "v0.17.1"

  # Python uses $TMPDIR envvar to find root of tempdir
  TMPDIR: "%TEMP%"
  TMP: "%TEMP%"

  # MSI Installers only use Py3.11. It is sufficient to test with this version here.
  PYTHON_HOME: "C:\\Python311-x64"
  PYTHON_SCRIPTS: "C:\\Python311-x64\\Scripts"
  PYTHON_EXE: "C:\\Python311-x64\\python.exe"
  PYTHON_ARCH: "64"
  HOME: 'C:\Users\appveyor'
  HOMEDRIVE: "C:"
  HOMEPATH: 'C:\Users\appveyor'
  NOSE_PARAMETERIZED_NO_WARN: 1
  AWS_S3: "AWS_S3_TESTING"
  AWS_ECR: "AWS_ECR_TESTING"
  APPVEYOR_CONSOLE_DISABLE_PTY: true

  SAM_WINDOWS_BINARY_PATH: "C:\\Program Files\\Amazon\\AWSSAMCLI_NIGHTLY\\bin\\sam-nightly.cmd"

init:
  # Uncomment this for RDP
  # - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  - ps: gcim Win32_Processor | % { "$($_.NumberOfLogicalProcessors) logical CPUs" }
  - ps: gcim Win32_OperatingSystem | % { "$([int]($_.TotalVisibleMemorySize/1mb)) Gb" }
  - git config --global core.autocrlf false
  - ps: New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
  - ps: git config --system core.longpaths true

install:

  # Make sure the temp directory exists for Python to use.
  - ps: "mkdir -Force C:\\tmp"
  - 'set PATH=%PYTHON_HOME%;C:\Ruby32-x64\bin;C:\Ruby33-x64\bin;C:\Ruby34-x64\bin;%PATH%;C:\Python39-x64;C:\Python310-x64;C:\Python38-x64;C:\Python312-x64;C:\Python313-x64;C:\Python314-x64'
  - "echo %PYTHON_HOME%"
  - "echo %PATH%"
  - "python --version"
  - ps: "Restart-Service docker"

  # Switch to Docker Linux containers
  - ps: |
      $dockerCliPath = "$Env:ProgramFiles\Docker\Docker\DockerCli.exe"
      if (Test-Path $dockerCliPath) {
        & $dockerCliPath -SwitchLinuxEngine
        Write-Host "Docker successfully switched to Linux container mode"
      } else {
        Write-Host "DockerCli.exe not found at expected location. Installing tree and exploring Docker directory structure..."
        choco install tree
        tree "$Env:ProgramFiles\Docker" /F /A
        Write-Host "Build stopped for Docker CLI investigation."
        exit 1
      }
  - "docker info"
  - "docker version"

  # claim some disk space before starting the tests
  - "docker system prune -a -f"


# Final clean up no matter success or failure
on_finish:
  # Upload test reports as artifacts
  - ps: "echo SUCCESS"


for:
  #Integ testing build
  - matrix:
      only:
        - configuration: BuildIntegTesting

    test_script:
      - ps: "ls"

  - matrix:
      only:
        - configuration: BuildIntegTestingJavaPythonProvided

    test_script:
      - ps: "ls"

  #Integ testing build arm64
  - matrix:
      only:
        - configuration: BuildIntegTestingArm64

    test_script:
      - ps: "ls"

  #Integ testing Terraform build
  - matrix:
      only:
        - configuration: AllTerraformBuildTesting

    test_script:
      - ps: "ls"

  # Integ testing package, delete and deploy
  - matrix:
      only:
        - configuration: PackageAndDeleteAndDeployIntegTesting

    test_script:
      - ps: "ls"

  # Integ testing sync
  - matrix:
      only:
        - configuration: SyncIntegTesting

    test_script:
      - ps: "ls"

  #Integ testing local invoke and generate event
  - matrix:
      only:
        - configuration: LocalInvokeIntegTesting

    test_script:
      - ps: "ls"

  #Integ testing local start-api
  - matrix:
      only:
        - configuration: LocalStartApiIntegTesting

    test_script:
      - ps: "ls"

  #Integ testing local start-lambda
  - matrix:
      only:
        - configuration: LocalStartLambdaIntegTesting

    test_script:
      - ps: "ls"

  #Other testing
  - matrix:
      only:
        - configuration: OtherAndEndToEndTesting

    test_script:
      - ps: "ls"

