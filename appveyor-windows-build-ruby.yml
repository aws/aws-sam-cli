version: 1.0.{build}
image: Visual Studio 2017
build: off

environment:
  AWS_DEFAULT_REGION: us-east-1
  SAM_CLI_DEV: 1
  APPVEYOR_CI_OVERRIDE: 1

  # MSI Installers only use Py3.6.6. It is sufficient to test with this version here.
  PYTHON_HOME: "C:\\Python36-x64"
  PYTHON_SCRIPTS: "C:\\Python36-x64\\Scripts"
  PYTHON_EXE: "C:\\Python36-x64\\python.exe"
  PYTHON_VERSION: '3.6.8'
  PYTHON_ARCH: '64'

  # To work around SSL issues when bundler installs a package
  # https://www.appveyor.com/docs/lang/ruby/#openssl-verification
  SSL_CERT_FILE: "C:\\tools\\ruby25\\ssl\\cert.pem"

  matrix:
    - optional_gate: true

matrix:
  allow_failures:
    - optional_gate: true

install:
    - "set PATH=%PYTHON%;%PYTHON%\\Scripts;%PYTHON%\\bin;%PATH%"
    - "%PYTHON%\\python.exe -m pip install -r requirements/dev.txt"
    - "%PYTHON%\\python.exe -m pip install -e ."
    - "set PATH=C:\\Ruby25-x64\\bin;%PATH%"
    - "gem --version"
    - "gem install bundler -v 1.17.3"
    - "bundler --version"
    - "echo %PATH%"

    # Echo final Path
    - "echo %PATH%"

    - "echo %SSL_CERT_FILE%"
    - "dir C:\\tools\\ruby25\\ssl"
    - "ruby -ropen-uri -e 'eval open(\"https://git.io/vQhWq\").read'"

test_script:
    # Reactivate virtualenv before running tests
    - "venv\\Scripts\\activate"
    - "pytest -vv tests/integration/buildcmd/test_build_cmd.py -k test_building_ruby_in_process"
