version: 1.0.{build}
image: Windows Server 2019
build: off

# Change the clone folder to somewhere in "D:\" because this is shared by default with Docker. We need this to mount folders.
clone_folder: D:\source

environment:
  AWS_DEFAULT_REGION: us-east-1
  SAM_CLI_DEV: 1
  
  matrix:
    - PYTHON_HOME: "C:\\Python27-x64"
      PYTHON_VERSION: '2.7'
      PYTHON_ARCH: '32'

    # Testing on both 32bit and 64bit Windows only for Latest Python version,
    # because MSIs installers use the latest Python3.6 version
    - PYTHON_HOME: "C:\\Python36"
      PYTHON_VERSION: '3.6'
      PYTHON_ARCH: '32'

    - PYTHON_HOME: "C:\\Python36-x64"
      PYTHON_VERSION: '3.6'
      PYTHON_ARCH: '64'

    - PYTHON_HOME: "C:\\Python37-x64"
      PYTHON_VERSION: '3.7'
      PYTHON_ARCH: '64'

init:
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  - gcim Win32_Processor | % { "$($_.NumberOfLogicalProcessors) logical CPUs" }
  - gcim Win32_OperatingSystem | % { "$([int]($_.TotalVisibleMemorySize/1mb)) Gb" }

cache:
  - C:\ProgramData\chocolatey\bin -> appveyor.yml
  - C:\ProgramData\chocolatey\lib -> appveyor.yml

install:
    # To run Nodejs workflow integ tests
    - ps: Install-Product node 10

    - "set PATH=%PYTHON%;%PYTHON%\\Scripts;%PYTHON%\\bin;%PATH%"
    - "python --version"
    - "python -m pip install -r requirements/dev.txt"
    - "python -m pip install -e ."

    # setup Ruby
    - "choco install ruby -y"
    - "refreshenv"
    - "ruby --version"
    - "gem --version"
    - "gem install bundler -v 1.17.3"
    - "refreshenv"
    - "bundler --version"
    - "echo %PATH%"

    # setup Java, Maven and Gradle
    - "refreshenv"
    - "choco install jdk8 -y"
    - "refreshenv"
    - "choco install maven -y"
    - "refreshenv"
    - "choco install gradle -y"
    - "refreshenv"
    - "java -version"
    - "gradle -v"
    - "mvn --version"

    # Echo final Path
    - "echo %PATH%"

    # Switch to Docker Linux containers
    - ps: Switch-DockerLinux
  
    # Upgrade setuptools, wheel and virtualenv
    - "python -m pip install --upgrade setuptools wheel virtualenv"

    # Create new virtual environment and activate it
    - "rm -rf venv"
    - "python -m virtualenv venv"
    - "venv\\Scripts\\activate"
    - "python -c \"import sys; print(sys.executable)\""

    # Actually install SAM CLI's dependencies
    - "pip install -e \".[dev]\""
test_script:
    - "pytest -vv tests\\integration"
    - "pytest --cov samcli --cov-report term-missing --cov-fail-under 95 tests\\unit"
    - "flake8 samcli"
    - "flake8 tests\\unit tests\\integration"
    - "pylint --rcfile .pylintrc samcli"
